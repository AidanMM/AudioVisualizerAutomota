<html>
  <head>
    <style>
	body {
         background: #eeeeee;
         font-family: tahoma, verdana, sans serif;
	 margin: 0 0 0 0;
	}

     	canvas {
        background: black;
    	}
      
      controls{
      	margin-left:10px;
        margin-top:10px;
      }

    </style>
  </head>

  <body>
    <canvas></canvas>
	<div id="controls">
		<audio controls loop></audio>
		<label>Track: 
			<select id="trackSelect" >
				<option value="media/17Years.mp3">17 Years</option>
				<option value="media/XP_Sounds.mp3">XP Song</option>
				<option value="media/Skrillex.mp3">Skrillex</option>
				<option value="media/OneWingedAngel.mp3">One Winged Angel</option>
				<option value="media/Lamprey.mp3">Lamprey</option>
				<option value="media/New Adventure Theme.mp3">New Adventure Theme</option>
				<option value="media/Peanuts Theme.mp3">Peanuts Theme</option>
				<option value="media/The Picard Song.mp3">The Picard Song</option>
			</select>
		</label>
		<span>
			<label for="lineCheck">Draw Lines</label>
			<input type="checkbox" id="lineCheck">
		</span>
		<select id ="lineSelect">
		<option value ="linear">Straight Lines</option>
		<option value ="quadratic" selected>Quadratic Lines</option>
		<option value ="cubic">Cubic Lines</option>
		</select>
		
		<div>
			<label for="controlPointSlider">Curviness</label>
			<input id="controlPointSlider" type ="range" min ="0.1" max="1.0" step ="0.1" value ="0.5"/>
			<span style="float:right" id="sliderResults">???</span>
		</div>
		<p id="status">???</p>
	</div>
  </body>
  
  <script src='setup.js'></script>
  <script src='automota.js'></script>
  <script>
  (function(){
	"use strict";
  	Draw.init()
   	window.onload = init;
    	var colony;
	var NUM_SAMPLES = 256;
	var SOUND_6 = 'media/XP_Sounds.mp3';
	var SOUND_4 = 'media/New Adventure Theme.mp3';
	var SOUND_2 = 'media/Peanuts Theme.mp3';
	var SOUND_3 = 'media/The Picard Song.mp3';
	var SOUND_5 = 'media/Skrillex.mp3';
	var SOUND_1 = 'media/17Years.mp3';
	var SOUND_7 = 'media/OneWingedAngel.mp3';
	var SOUND_8 = 'media/Lamprey.mp3';
	var audioElement;
	var analyserNode;
	function init() {
		// Initialize audio systems
		audioElement = document.querySelector('audio');
		analyserNode = createWebAudioContextWithAnalyserNode(audioElement);
		setupUI();
		playStream(audioElement,SOUND_1);
		colony = Colony.create(Draw.canvas.width, Draw.canvas.height, NUM_SAMPLES / 2, NUM_SAMPLES / 2);
		//colony.randomizeState();
		update();
	}
	function createWebAudioContextWithAnalyserNode(audioElement) {
		var audioCtx, analyserNode, sourceNode;

		// create new AudioContext
		// The || is because WebAudio has not been standardized across browsers yet
		// http://webaudio.github.io/web-audio-api/#the-audiocontext-interface
		audioCtx = new (window.AudioContext || window.webkitAudioContext);
			
		// create an analyser node
		analyserNode = audioCtx.createAnalyser();
			
		/*
		We will request NUM_SAMPLES number of samples or "bins" spaced equally 
		across the sound spectrum.
			
		If NUM_SAMPLES (fftSize) is 256, then the first bin is 0 Hz, the second is 172 Hz, 
		the third is 344Hz. Each bin contains a number between 0-255 representing 
		the amplitude of that frequency.
		*/ 
			
		// fft stands for Fast Fourier Transform
		analyserNode.fftSize = NUM_SAMPLES;
			
		// this is where we hook up the <audio> element to the analyserNode
		sourceNode = audioCtx.createMediaElementSource(audioElement); 
		sourceNode.connect(analyserNode);
			
		// here we connect to the destination i.e. speakers
		analyserNode.connect(audioCtx.destination);
		return analyserNode;
	}
	function setupUI(){
		document.querySelector("#trackSelect").onchange = function(e){
			playStream(audioElement,e.target.value);
			colony.clearState();
		};
	}
	function playStream(audioElement,path){
		audioElement.src = path;
		audioElement.play();
		audioElement.volume = 0.2;
		document.querySelector('#status').innerHTML = "Now playing: " + path;
	}
	function update() {
		var delay = 25;
		setTimeout(function(){
			requestAnimationFrame(update);	
			//Draw.ctx.clearRect(0,0,Draw.canvas.width, Draw.canvas.height);
			Draw.ctx.fillStyle = "rgba(0,0,0,.1)"; 
			Draw.ctx.fillRect(0,0,Draw.canvas.width ,Draw.canvas.height );
			colony.draw(Draw.ctx);
			colony.update();
			// create a new array of 8-bit integers (0-255)
			var data = new Uint8Array(NUM_SAMPLES); 
			
			// populate the array with the frequency data
			// notice these arrays can be passed "by reference" 
			analyserNode.getByteFrequencyData(data);
			
			// DRAW!
			var barWidth = Math.round(Draw.canvas.width / data.length);
			var barSpacing = 1;
			var barHeight = 100;
			var topSpacing = 50;
			
			// loop through the data and draw!
			for(var i=0; i<NUM_SAMPLES / 4; i++) { 
				Draw.ctx.fillStyle = 'rgba(0,255,0,0.6)'; 
				
				// the higher the amplitude of the sample (bin) the taller the bar
				// remember we have to draw our bars left-to-right and top-down
				//Draw.ctx.fillRect(i * (barWidth + barSpacing),topSpacing + 256-data[i],barWidth,barHeight); 
				//Draw.ctx.fillRect(Draw.canvas.width - i * (barWidth + barSpacing), topSpacing + 256 - data[i] - 20, barWidth, barHeight);
				if(data[i] > 100) {
					colony.automota[i][Math.round(colony.ySize / 2)].nextState = Math.round(data[i] / 25);		
					//colony.automota[i][1].nextState = Math.round(data[i] / 25);		
					//colony.automota[i][colony.ySize - 1 ].nextState = Math.round(data[i] / 25);		
				}
			}
			var extraCount = 0;
			for(var i=NUM_SAMPLES / 2 - 1; i > NUM_SAMPLES / 4; i--) { 
				Draw.ctx.fillStyle = 'rgba(0,255,0,0.6)'; 
				
				// the higher the amplitude of the sample (bin) the taller the bar
				// remember we have to draw our bars left-to-right and top-down
				//Draw.ctx.fillRect(i * (barWidth + barSpacing),topSpacing + 256-data[i],barWidth,barHeight); 
				//Draw.ctx.fillRect(Draw.canvas.width - i * (barWidth + barSpacing), topSpacing + 256 - data[i] - 20, barWidth, barHeight);
				if(data[extraCount] > 100) {
					colony.automota[i][Math.round(colony.ySize / 2)].nextState = Math.round(data[extraCount] / 25);		
					//colony.automota[i][1].nextState = Math.round(data[extraCount] / 25);		
					//colony.automota[i][colony.ySize - 1 ].nextState = Math.round(data[extraCount] / 25);		
				}
				extraCount++;
			}
			manipulatePixels();
		}, delay);
	}
	function manipulatePixels() {
		var imageData = Draw.ctx.getImageData(0, 0, Draw.canvas.width, Draw.canvas.height);
		var data = imageData.data;
		var length = data.length;
		var width = imageData.width;
		for(var i = 0; i < length; i += 4) {
			/*if( (data[i] || data[i + 1] || data[i + 2] > 0) && (i + 4 < length && !(data[i + 4] > 0 || data[1 + 5] > 0 || data[i + 6] > 0 ))) {
				data[i + 4] = Math.round( data[i] / 2);
				data[i + 5] = Math.round(data[i + 1] / 2);
				data[i + 6] = Math.round(data[i + 2] / 2);
				data[i + 7] = 200;
			}*/
		}
		Draw.ctx.putImageData(imageData, 0, 0);
	}
		
		// HELPER
	function makeColor(red, green, blue, alpha){
   		var color='rgba('+red+','+green+','+blue+', '+alpha+')';
   		return color;
	}
  }());

  </script>

</html>
